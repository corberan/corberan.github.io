<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emscripten-Generated Code</title>
    <style>
body {
  font-family: arial;
  margin: 0;
  padding: 0;
}

.emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
div.emscripten { text-align: center; }
div.emscripten_border { border: 1px solid black; }
/* the canvas *must not* have any border or padding, or mouse coords will be wrong */
canvas.emscripten { border: 0px none; background-color: black; }

#emscripten_logo {
  display: inline-block;
  margin: 0;
  padding: 6px;
  width: 265px;
}

.spinner {
  height: 30px;
  width: 30px;
  margin: 0;
  margin-top: 20px;
  margin-left: 20px;
  display: inline-block;
  vertical-align: top;

  -webkit-animation: rotation .8s linear infinite;
  -moz-animation: rotation .8s linear infinite;
  -o-animation: rotation .8s linear infinite;
  animation: rotation 0.8s linear infinite;

  border-left: 5px solid rgb(235, 235, 235);
  border-right: 5px solid rgb(235, 235, 235);
  border-bottom: 5px solid rgb(235, 235, 235);
  border-top: 5px solid rgb(120, 120, 120);

  border-radius: 100%;
  background-color: rgb(189, 215, 46);
}

@-webkit-keyframes rotation {
  from {-webkit-transform: rotate(0deg);}
  to {-webkit-transform: rotate(360deg);}
}
@-moz-keyframes rotation {
  from {-moz-transform: rotate(0deg);}
  to {-moz-transform: rotate(360deg);}
}
@-o-keyframes rotation {
  from {-o-transform: rotate(0deg);}
  to {-o-transform: rotate(360deg);}
}
@keyframes rotation {
  from {transform: rotate(0deg);}
  to {transform: rotate(360deg);}
}

#status {
  display: inline-block;
  vertical-align: top;
  margin-top: 30px;
  margin-left: 20px;
  font-weight: bold;
  color: rgb(120, 120, 120);
}

#progress {
  height: 20px;
  width: 300px;
}

#controls {
  display: inline-block;
  float: right;
  vertical-align: top;
  margin-top: 30px;
  margin-right: 20px;
}

/* Canvas容器样式 */
#canvas-container {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto;
  min-height: 400px;
}

.emscripten_border {
  display: inline-block;
  transform-origin: center center;
  transition: transform 0.1s;
}

/* 缩放控制条样式 */
#zoom-control {
  width: 90%;
  max-width: 600px;
  margin: 10px auto;
  text-align: center;
}

#zoom-slider {
  width: 100%;
  margin: 5px 0;
}

#zoom-label {
  font-size: 14px;
  color: #333;
}

/* 虚拟键盘样式 */
#virtual-keyboard {
  margin: 20px auto;
  padding: 20px;
  background-color: #f0f0f0;
  border-radius: 10px;
  max-width: 600px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
}

.keyboard-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

.key-button {
  background: linear-gradient(to bottom, #ffffff, #e0e0e0);
  border: 2px solid #999;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  color: #333;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.1s;
  touch-action: none;
}

.key-button:active {
  background: linear-gradient(to bottom, #d0d0d0, #b0b0b0);
  box-shadow: 0 2px 3px rgba(0,0,0,0.2);
  transform: translateY(2px);
}

.key-button.pressed {
  background: linear-gradient(to bottom, #b0b0b0, #909090);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

#key-esc {
  width: 80px;
  height: 50px;
}

/* 方向键容器 */
.arrow-keys {
  display: grid;
  grid-template-columns: repeat(3, 60px);
  grid-template-rows: repeat(3, 50px);
  gap: 5px;
  margin: 0 10px;
}

#key-up {
  grid-column: 2;
  grid-row: 1;
}

#key-left {
  grid-column: 1;
  grid-row: 2;
}

#key-down {
  grid-column: 2;
  grid-row: 3;
}

#key-right {
  grid-column: 3;
  grid-row: 2;
}

.arrow-key {
  width: 60px;
  height: 50px;
  font-size: 20px;
}

#key-enter {
  width: 100px;
  height: 50px;
}

/* 日志区样式 */
#output-container {
  width: 95%;
  margin: 10px auto;
  background-color: black;
  border-radius: 5px;
  overflow: hidden;
}

#output-header {
  background-color: #333;
  color: white;
  padding: 10px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#output-toggle {
  font-size: 12px;
  color: #aaa;
}

#output {
  width: calc(100% - 20px);
  height: 200px;
  margin: 0;
  padding: 10px;
  display: none;
  background-color: black;
  color: white;
  font-family: 'Lucida Console', Monaco, monospace;
  outline: none;
  border: none;
  resize: none;
}

#output.expanded {
  display: block;
}

/* 响应式设计 */
@media (max-width: 768px) {
  #controls {
    float: none;
    display: block;
    margin: 10px auto;
    text-align: center;
  }
  
  #controls span {
    display: block;
    margin: 5px 0;
  }
  
  .key-button {
    font-size: 14px;
  }
  
  .arrow-keys {
    grid-template-columns: repeat(3, 50px);
    grid-template-rows: repeat(3, 40px);
  }
  
  .arrow-key {
    width: 50px;
    height: 40px;
    font-size: 16px;
  }
  
  #key-esc, #key-enter {
    height: 40px;
  }
}

/* 控制面板样式 */
#control-panel {
  max-width: 600px;
  margin: 20px auto;
  padding: 15px;
  background-color: #f5f5f5;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.control-group {
  margin: 15px 0;
}

.control-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #333;
}

.control-group input[type="text"],
.control-group input[type="number"] {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-sizing: border-box;
}

.control-group button {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.control-group button:hover {
  background-color: #45a049;
}

.control-group button:active {
  background-color: #3d8b40;
}

#speed-value {
  display: inline-block;
  margin-left: 10px;
  font-weight: normal;
  color: #666;
}

/* 键盘模式切换按钮 */
#keyboard-mode-toggle {
  margin: 10px auto;
  text-align: center;
}

#keyboard-mode-toggle button {
  background-color: #2196F3;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

#keyboard-mode-toggle button:hover {
  background-color: #0b7dda;
}

/* 全键盘样式 */
.full-keyboard .keyboard-row {
  gap: 5px;
  margin: 5px 0;
}

.full-keyboard .key-button {
  min-width: 35px;
  height: 40px;
  font-size: 14px;
  padding: 5px;
}

.full-keyboard .key-button.wide {
  min-width: 60px;
}

.full-keyboard .key-button.extra-wide {
  min-width: 100px;
}

</style>
  </head>
  <body>
    <div class="spinner" id='spinner'></div>
    <div class="emscripten" id="status">Downloading...</div>

    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>

    <!-- 缩放控制 -->
    <div id="zoom-control">
      <label id="zoom-label">Canvas Scale: 100%</label>
      <input type="range" id="zoom-slider" min="25" max="200" value="100" step="5">
    </div>

    <!-- 控制面板 -->
<div id="control-panel">
  <div class="control-group">
    <label for="bin-path">Bin File Path:</label>
    <input type="text" id="bin-path" value="/bbasic/剑侠风云.bin" placeholder="/bbasic/yourfile.bin">
  </div>
  
  <div class="control-group">
    <label>Screen Size:</label>
    <div style="display: flex; gap: 10px;">
      <input type="number" id="screen-width" value="240" min="100" max="2000" placeholder="Width" style="width: 48%;">
      <input type="number" id="screen-height" value="320" min="100" max="2000" placeholder="Height" style="width: 48%;">
    </div>
  </div>
  
  <div class="control-group">
    <label for="model-type">Model Type:</label>
    <input type="text" id="model-type" value="" placeholder="Model identifier (optional)">
  </div>
  
  <div class="control-group">
    <label for="speed-slider">
      VM Clock Speed: <span id="speed-value">60000 Hz</span>
    </label>
    <input type="range" id="speed-slider" min="10000" max="200000" value="60000" step="1000">
  </div>
  
  <div class="control-group">
    <button id="load-bin-button">Load and Run Bin File</button>
  </div>
</div>



    <!-- Canvas容器 -->
    <div id="canvas-container">
      <div class="emscripten_border" id="canvas-wrapper">
        <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
      </div>
    </div>

    <!-- 虚拟键盘 -->
    <!-- <div id="virtual-keyboard">
      <div class="keyboard-row">
        <button class="key-button" id="key-esc">ESC</button>
        <div class="arrow-keys">
          <button class="key-button arrow-key" id="key-up">▲</button>
          <button class="key-button arrow-key" id="key-left">◄</button>
          <button class="key-button arrow-key" id="key-down">▼</button>
          <button class="key-button arrow-key" id="key-right">►</button>
        </div>
        <button class="key-button" id="key-enter">ENTER</button>
      </div>
    </div> -->

    <!-- 虚拟键盘 -->
<div id="keyboard-mode-toggle">
  <button id="toggle-keyboard-btn">Switch to Full Keyboard</button>
</div>

<div id="virtual-keyboard" class="basic-keyboard">
  <!-- 基础键盘 -->
  <div id="basic-keyboard-layout">
    <div class="keyboard-row">
      <button class="key-button" id="key-esc">ESC</button>
      <div class="arrow-keys">
        <button class="key-button arrow-key" id="key-up">▲</button>
        <button class="key-button arrow-key" id="key-left">◄</button>
        <button class="key-button arrow-key" id="key-down">▼</button>
        <button class="key-button arrow-key" id="key-right">►</button>
      </div>
      <button class="key-button" id="key-enter">ENTER</button>
    </div>
  </div>
  
  <!-- 全键盘 -->
  <div id="full-keyboard-layout" style="display: none;">
    <div class="keyboard-row">
      <button class="key-button" data-key="q">Q</button>
      <button class="key-button" data-key="w">W</button>
      <button class="key-button" data-key="e">E</button>
      <button class="key-button" data-key="r">R</button>
      <button class="key-button" data-key="t">T</button>
      <button class="key-button" data-key="y">Y</button>
      <button class="key-button" data-key="u">U</button>
      <button class="key-button" data-key="i">I</button>
      <button class="key-button" data-key="o">O</button>
      <button class="key-button" data-key="p">P</button>
    </div>
    <div class="keyboard-row">
      <button class="key-button" data-key="a">A</button>
      <button class="key-button" data-key="s">S</button>
      <button class="key-button" data-key="d">D</button>
      <button class="key-button" data-key="f">F</button>
      <button class="key-button" data-key="g">G</button>
      <button class="key-button" data-key="h">H</button>
      <button class="key-button" data-key="j">J</button>
      <button class="key-button" data-key="k">K</button>
      <button class="key-button" data-key="l">L</button>
    </div>
    <div class="keyboard-row">
      <button class="key-button" data-key="z">Z</button>
      <button class="key-button" data-key="x">X</button>
      <button class="key-button" data-key="c">C</button>
      <button class="key-button" data-key="v">V</button>
      <button class="key-button" data-key="b">B</button>
      <button class="key-button" data-key="n">N</button>
      <button class="key-button" data-key="m">M</button>
      <button class="key-button" data-key=",">,</button>
      <button class="key-button" data-key=".">.</button>
    </div>
    <div class="keyboard-row">
      <button class="key-button" data-key="1">1</button>
      <button class="key-button" data-key="2">2</button>
      <button class="key-button" data-key="3">3</button>
      <button class="key-button" data-key="4">4</button>
      <button class="key-button" data-key="5">5</button>
      <button class="key-button" data-key="6">6</button>
      <button class="key-button" data-key="7">7</button>
      <button class="key-button" data-key="8">8</button>
      <button class="key-button" data-key="9">9</button>
      <button class="key-button" data-key="0">0</button>
    </div>
    <div class="keyboard-row">
      <button class="key-button" id="key-esc-full">ESC</button>
      <button class="key-button extra-wide" data-key=" ">SPACE</button>
      <button class="key-button" data-key="Backspace">⌫</button>
      <button class="key-button" id="key-enter-full">ENTER</button>
    </div>
    <div class="keyboard-row">
      <div class="arrow-keys">
        <button class="key-button arrow-key" id="key-up-full">▲</button>
        <button class="key-button arrow-key" id="key-left-full">◄</button>
        <button class="key-button arrow-key" id="key-down-full">▼</button>
        <button class="key-button arrow-key" id="key-right-full">►</button>
      </div>
    </div>
  </div>
</div>


    <!-- 日志输出区 -->
    <div id="output-container">
      <div id="output-header">
        <span>Console Output</span>
        <span id="output-toggle">▼ Click to expand</span>
      </div>
      <textarea id="output" rows="8"></textarea>
    </div>

    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var spinnerElement = document.getElementById('spinner');
      var canvasElement = document.getElementById('canvas');
      var outputElement = document.getElementById('output');
      if (outputElement) outputElement.value = ''; // clear browser cache

      // 缩放功能
      const zoomSlider = document.getElementById('zoom-slider');
      const zoomLabel = document.getElementById('zoom-label');
      const canvasWrapper = document.getElementById('canvas-wrapper');
      const canvasContainer = document.getElementById('canvas-container');

      function updateCanvasScale() {
        const scale = zoomSlider.value / 100;
        canvasWrapper.style.transform = `scale(${scale})`;
        zoomLabel.textContent = `Canvas Scale: ${zoomSlider.value}%`;
        
        // 根据缩放比例动态调整容器高度
        const canvasHeight = canvasElement.height || 600; // 默认高度
        const scaledHeight = canvasHeight * scale;
        canvasContainer.style.minHeight = scaledHeight + 'px';
      }

      zoomSlider.addEventListener('input', updateCanvasScale);

      // 监听canvas尺寸变化（如果canvas动态改变大小）
      const resizeObserver = new ResizeObserver(() => {
        updateCanvasScale();
      });
      resizeObserver.observe(canvasElement);

      // 日志区展开/收起
      const outputHeader = document.getElementById('output-header');
      const outputToggle = document.getElementById('output-toggle');

      outputHeader.addEventListener('click', function() {
        outputElement.classList.toggle('expanded');
        if (outputElement.classList.contains('expanded')) {
          outputToggle.textContent = '▲ Click to collapse';
        } else {
          outputToggle.textContent = '▼ Click to expand';
        }
      });

      // 虚拟键盘功能
      const keyMapping = {
        'key-esc': { key: 'Escape', keyCode: 27, code: 'Escape' },
        'key-up': { key: 'ArrowUp', keyCode: 38, code: 'ArrowUp' },
        'key-down': { key: 'ArrowDown', keyCode: 40, code: 'ArrowDown' },
        'key-left': { key: 'ArrowLeft', keyCode: 37, code: 'ArrowLeft' },
        'key-right': { key: 'ArrowRight', keyCode: 39, code: 'ArrowRight' },
        'key-enter': { key: 'Enter', keyCode: 13, code: 'Enter' }
      };

      let keyRepeatIntervals = {};
      let keyRepeatTimeouts = {};

      function dispatchKeyEvent(eventType, keyInfo) {
        // 为document派发事件
        const event1 = new KeyboardEvent(eventType, {
          key: keyInfo.key,
          keyCode: keyInfo.keyCode,
          code: keyInfo.code,
          which: keyInfo.keyCode,
          bubbles: true,
          cancelable: true
        });
        document.dispatchEvent(event1);

        // 为canvas派发事件
        const event2 = new KeyboardEvent(eventType, {
          key: keyInfo.key,
          keyCode: keyInfo.keyCode,
          code: keyInfo.code,
          which: keyInfo.keyCode,
          bubbles: true,
          cancelable: true
        });
        canvasElement.dispatchEvent(event2);
      }

      function startKeyPress(buttonId, keyInfo) {
        const button = document.getElementById(buttonId);
        button.classList.add('pressed');
        
        // 立即触发一次keydown
        dispatchKeyEvent('keydown', keyInfo);
        
        // 如果是方向键，设置长按重复
        if (buttonId.startsWith('key-up') || buttonId.startsWith('key-down') || 
            buttonId.startsWith('key-left') || buttonId.startsWith('key-right')) {
          
          // 延迟后开始重复（模拟系统键盘行为）
          keyRepeatTimeouts[buttonId] = setTimeout(() => {
            // 检查按钮是否仍然处于按下状态
            if (keyRepeatIntervals[buttonId] === 'waiting') {
              keyRepeatIntervals[buttonId] = setInterval(() => {
                dispatchKeyEvent('keydown', keyInfo);
              }, 80); // 每80ms触发一次
            }
          }, 300); // 300ms后开始重复
          
          keyRepeatIntervals[buttonId] = 'waiting'; // 标记为等待重复状态
        }
      }

      function endKeyPress(buttonId, keyInfo) {
        const button = document.getElementById(buttonId);
        button.classList.remove('pressed');
        
        // 清除延迟触发的timeout
        if (keyRepeatTimeouts[buttonId]) {
          clearTimeout(keyRepeatTimeouts[buttonId]);
          delete keyRepeatTimeouts[buttonId];
        }
        
        // 清除重复触发的interval
        if (keyRepeatIntervals[buttonId] && keyRepeatIntervals[buttonId] !== 'waiting') {
          clearInterval(keyRepeatIntervals[buttonId]);
        }
        delete keyRepeatIntervals[buttonId];
        
        // 触发keyup事件
        dispatchKeyEvent('keyup', keyInfo);
      }

      // 为每个按键绑定事件
      Object.keys(keyMapping).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        const keyInfo = keyMapping[buttonId];

        // 鼠标事件
        button.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startKeyPress(buttonId, keyInfo);
        });

        button.addEventListener('mouseup', (e) => {
          e.preventDefault();
          endKeyPress(buttonId, keyInfo);
        });

        button.addEventListener('mouseleave', (e) => {
          // 只有在按钮被按下的情况下才触发结束
          if (keyRepeatIntervals[buttonId]) {
            endKeyPress(buttonId, keyInfo);
          }
        });

        // 触摸事件（移动端）
        button.addEventListener('touchstart', (e) => {
          e.preventDefault();
          startKeyPress(buttonId, keyInfo);
        });

        button.addEventListener('touchend', (e) => {
          e.preventDefault();
          endKeyPress(buttonId, keyInfo);
        });

        button.addEventListener('touchcancel', (e) => {
          e.preventDefault();
          // 只有在按钮被按下的情况下才触发结束
          if (keyRepeatIntervals[buttonId]) {
            endKeyPress(buttonId, keyInfo);
          }
        });
      });

      // 全局鼠标/触摸释放事件，确保在任何情况下都能停止重复
      document.addEventListener('mouseup', () => {
        Object.keys(keyRepeatIntervals).forEach(buttonId => {
          if (keyRepeatIntervals[buttonId]) {
            endKeyPress(buttonId, keyMapping[buttonId]);
          }
        });
      });

      document.addEventListener('touchend', () => {
        Object.keys(keyRepeatIntervals).forEach(buttonId => {
          if (keyRepeatIntervals[buttonId]) {
            endKeyPress(buttonId, keyMapping[buttonId]);
          }
        });
      });

      // 防止页面滚动
      document.getElementById('virtual-keyboard').addEventListener('touchmove', (e) => {
        e.preventDefault();
      }, { passive: false });

      // As a default initial behavior, pop up an alert when webgl context is lost. To make your
      // application robust, you may want to override this behavior before shipping!
      // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
      canvasElement.addEventListener('webglcontextlost', (e) => {
        alert('WebGL context lost. You will need to reload the page.');
        e.preventDefault();
      }, false);

      var Module = {
        print(...args) {
          console.log(...args);
          if (outputElement) {
            var text = args.join(' ');
            outputElement.value += text + "\n";
            outputElement.scrollTop = outputElement.scrollHeight; // focus on bottom
          }
        },
        canvas: canvasElement,
        setStatus(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return;
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.style.display = 'none';
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = (event) => {
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = (text) => {
          if (text) console.error('[post-exception status] ' + text);
        };
      };

      // 控制面板功能
const binPathInput = document.getElementById('bin-path');
const screenWidthInput = document.getElementById('screen-width');
const screenHeightInput = document.getElementById('screen-height');
const modelTypeInput = document.getElementById('model-type');
const speedSlider = document.getElementById('speed-slider');
const speedValue = document.getElementById('speed-value');
const loadBinButton = document.getElementById('load-bin-button');

// 更新速度显示
speedSlider.addEventListener('input', function() {
  const speed = this.value;
  speedValue.textContent = speed + ' Hz';
  if (Module._set_vm_clock_speed) {
    Module._set_vm_clock_speed(parseInt(speed));
  }
});

// 加载bin文件
// 加载bin文件
loadBinButton.addEventListener('click', function() {
  const binPath = binPathInput.value.trim();
  const modelType = modelTypeInput.value.trim();
  const width = parseInt(screenWidthInput.value) || 240;
  const height = parseInt(screenHeightInput.value) || 320;
  
  if (!binPath) {
    alert('Please enter a bin file path');
    return;
  }
  
  if (width < 100 || width > 2000 || height < 100 || height > 2000) {
    alert('Screen size must be between 100x100 and 2000x2000');
    return;
  }
  
  this.disabled = true;
  this.textContent = 'Loading...';
  
  // 延迟执行，让UI有时间更新
  setTimeout(() => {
    try {
      // 使用 ccall 来正确处理字符串传递
      const result = Module.ccall(
        'load_and_run_bin',  // C函数名
        'number',            // 返回类型
        ['string', 'number', 'number', 'string'],  // 参数类型
        [binPath, width, height, modelType || '']  // 参数值
      );
      
      if (result === 0) {
        Module.print('Successfully loaded: ' + binPath);
        Module.print('Screen size: ' + width + 'x' + height);
        
        // 更新Canvas容器的最小高度以适应新尺寸
        const scale = zoomSlider.value / 100;
        const scaledHeight = height * scale;
        canvasContainer.style.minHeight = scaledHeight + 'px';
      } else if (result === -2) {
        Module.print('Failed to reinitialize SDL window');
        alert('Failed to set window size. Check console for details.');
      } else {
        Module.print('Failed to load: ' + binPath);
        alert('Failed to load bin file. Check console for details.');
      }
    } catch (error) {
      Module.print('Error calling load_and_run_bin: ' + error);
      alert('Error: ' + error);
    }
    
    loadBinButton.disabled = false;
    loadBinButton.textContent = 'Load and Run Bin File';
  }, 100);
});


// 键盘模式切换
const toggleKeyboardBtn = document.getElementById('toggle-keyboard-btn');
const virtualKeyboard = document.getElementById('virtual-keyboard');
const basicLayout = document.getElementById('basic-keyboard-layout');
const fullLayout = document.getElementById('full-keyboard-layout');
let isFullKeyboard = false;

toggleKeyboardBtn.addEventListener('click', function() {
  isFullKeyboard = !isFullKeyboard;
  
  if (isFullKeyboard) {
    basicLayout.style.display = 'none';
    fullLayout.style.display = 'block';
    virtualKeyboard.classList.remove('basic-keyboard');
    virtualKeyboard.classList.add('full-keyboard');
    this.textContent = 'Switch to Basic Keyboard';
  } else {
    basicLayout.style.display = 'block';
    fullLayout.style.display = 'none';
    virtualKeyboard.classList.remove('full-keyboard');
    virtualKeyboard.classList.add('basic-keyboard');
    this.textContent = 'Switch to Full Keyboard';
  }
});

// 为全键盘按钮添加事件处理
function setupFullKeyboard() {
  // 字母和数字键
  const alphanumericKeys = fullLayout.querySelectorAll('.key-button[data-key]');
  alphanumericKeys.forEach(button => {
    const key = button.getAttribute('data-key');
    let keyCode, code;
    
    if (key === ' ') {
      keyCode = 32;
      code = 'Space';
    } else if (key === 'Backspace') {
      keyCode = 8;
      code = 'Backspace';
    } else if (key === ',') {
      keyCode = 188;
      code = 'Comma';
    } else if (key === '.') {
      keyCode = 190;
      code = 'Period';
    } else {
      keyCode = key.toUpperCase().charCodeAt(0);
      code = 'Key' + key.toUpperCase();
    }
    
    const keyInfo = { key: key, keyCode: keyCode, code: code };
    
    button.addEventListener('mousedown', (e) => {
      e.preventDefault();
      startKeyPress('full-' + key, keyInfo);
    });
    
    button.addEventListener('mouseup', (e) => {
      e.preventDefault();
      endKeyPress('full-' + key, keyInfo);
    });
    
    button.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startKeyPress('full-' + key, keyInfo);
    });
    
    button.addEventListener('touchend', (e) => {
      e.preventDefault();
      endKeyPress('full-' + key, keyInfo);
    });
  });
  
  // ESC和Enter键（全键盘版本）
  const fullEsc = document.getElementById('key-esc-full');
  const fullEnter = document.getElementById('key-enter-full');
  
  if (fullEsc) {
    setupKeyButton(fullEsc, 'key-esc-full', 
      { key: 'Escape', keyCode: 27, code: 'Escape' });
  }
  
  if (fullEnter) {
    setupKeyButton(fullEnter, 'key-enter-full',
      { key: 'Enter', keyCode: 13, code: 'Enter' });
  }
  
  // 方向键（全键盘版本）
  setupKeyButton(document.getElementById('key-up-full'), 'key-up-full',
    { key: 'ArrowUp', keyCode: 38, code: 'ArrowUp' });
  setupKeyButton(document.getElementById('key-down-full'), 'key-down-full',
    { key: 'ArrowDown', keyCode: 40, code: 'ArrowDown' });
  setupKeyButton(document.getElementById('key-left-full'), 'key-left-full',
    { key: 'ArrowLeft', keyCode: 37, code: 'ArrowLeft' });
  setupKeyButton(document.getElementById('key-right-full'), 'key-right-full',
    { key: 'ArrowRight', keyCode: 39, code: 'ArrowRight' });
}

function setupKeyButton(button, buttonId, keyInfo) {
  if (!button) return;
  
  button.addEventListener('mousedown', (e) => {
    e.preventDefault();
    startKeyPress(buttonId, keyInfo);
  });
  
  button.addEventListener('mouseup', (e) => {
    e.preventDefault();
    endKeyPress(buttonId, keyInfo);
  });
  
  button.addEventListener('touchstart', (e) => {
    e.preventDefault();
    startKeyPress(buttonId, keyInfo);
  });
  
  button.addEventListener('touchend', (e) => {
    e.preventDefault();
    endKeyPress(buttonId, keyInfo);
  });
}

// 初始化全键盘
setupFullKeyboard();

    </script>
    <script async type="text/javascript" src="index.js"></script>
  </body>
</html>
